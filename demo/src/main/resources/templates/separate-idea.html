<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Idea Details</title>
    <link rel="stylesheet" th:href="@{/default-style.css}">
    <link rel="stylesheet" th:href="@{/separate-idea-style.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/css/theme.default.min.css">
</head>
<body>
<div class="container">
    <div th:replace="~{fragments/header :: header(
    title='Bootcamp Ideas',
    subtitle=${competitionName},
    message=${competitionDescription},
    user=${user},
    link1Href='/ideas',
    link1Text='See all ideas',
    link2Href='/notready',
    link2Text='',
    link3Href='/notready',
    link3Text=''
)}"></div>
    <div class="idea-details" th:object="${idea}">
        <h3 th:text="${idea.title}"></h3>

        <!-- Bookmark checkbox with "Favorite?" label -->
        <label for="bookmark" class="small-label">Favorite?</label>
        <input type="checkbox" id="bookmark" name="bookmark"
               th:checked="${bookmarkStatusMap[idea.id]}"
               th:data-id="${idea.id}"
               th:data-user-id="${user_id}"
               onchange="toggleBookmark(this)">

        <p><strong>Author:</strong> <span th:text="${idea.user.username}"></span></p>
        <p><strong>Category:</strong> <span th:each="category : ${idea.categories}"
                                            th:text="${category.name}"></span></p>
        <p><strong>Description:</strong> <span th:text="${idea.description}"></span></p>
        <p><strong>Key Features:</strong> <span th:text="${idea.keyFeatures}"></span></p>
        <p><strong>References:</strong> <a th:href="${idea.referenceLinks}" th:text="${idea.referenceLinks}"
                                           target="_blank"></a></p>
        <div th:if="${idea.pictures}">
            <p><strong>Images:</strong></p>
            <div class="picture-gallery">
                <div th:each="picture : ${idea.pictures}">
                    <img th:src="@{${picture}}" alt="Idea Picture" style="max-width: 100%; height: auto; margin-bottom: 10px;">
                </div>
            </div>
        </div>

        <hr>

        <div class="comments-section">
            <h2>Comments</h2>
            <form method="post" action="/add-comment">
                <input type="hidden" name="ideaId" th:value="${idea.id}" />
                <input type="hidden" name="userId" th:value="${user_id}" />
                <textarea id="comment" name="content" placeholder="Add your comment"></textarea>
                <button type="submit">Submit Comment</button>
            </form>

            <div class="comment-list">
                <div th:each="comment : ${comments}">
                    <p>
                        <strong th:text="${comment.user.username}"></strong>:
                        <span th:text="${comment.content}"></span>
                    </p>
                </div>
            </div>
        </div>

        <footer>
            <a href="/logout" class="footer-link">Log out</a>
        </footer>
    </div>

    <script>
        function toggleBookmark(checkbox) {
            const ideaId = checkbox.getAttribute('data-id');
            const userId = checkbox.getAttribute('data-user-id');
            const isBookmarked = checkbox.checked;

            if (isBookmarked) {
                $.ajax({
                    url: '/bookmark/add',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        ideaId: ideaId,
                        userId: userId,
                        bookmarked: true
                    }),
                    success: function (response) {
                        console.log('Bookmark added:', response);
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX Error:', status, error);
                        checkbox.checked = false;
                    }
                });
            } else {
                $.ajax({
                    url: '/bookmark/delete',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        ideaId: ideaId,
                        userId: userId
                    }),
                    success: function (response) {
                        console.log('Bookmark deleted:', response);
                    },
                    error: function (xhr, status, error) {
                        console.error('AJAX Error:', status, error);
                        checkbox.checked = true;
                    }
                });
            }
        }
    </script>
</div>
</body>
</html>

